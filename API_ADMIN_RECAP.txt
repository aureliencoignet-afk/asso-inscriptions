â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                  RÃ‰CAPITULATIF : app/api/admin                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‚ STRUCTURE EXACTE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

app/
â””â”€â”€ api/
    â””â”€â”€ admin/
        â””â”€â”€ users/
            â”œâ”€â”€ route.ts                  (Fichier 1)
            â””â”€â”€ [id]/
                â””â”€â”€ route.ts              (Fichier 2)

TOTAL : 2 FICHIERS dans app/api/admin

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“„ FICHIER 1 : app/api/admin/users/route.ts
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

RÃ”LE : CrÃ©er un nouvel utilisateur

MÃ‰THODE : POST

ENDPOINT : /api/admin/users

FONCTIONNALITÃ‰S :
  âœ… VÃ©rifie que l'utilisateur actuel est admin
  âœ… Valide les donnÃ©es (email, password, first_name, last_name, role)
  âœ… Utilise createAdminClient() avec service_role
  âœ… CrÃ©e l'utilisateur dans auth.users
  âœ… CrÃ©e le profil dans profiles
  âœ… Rollback automatique si erreur profil

BODY EXEMPLE :
{
  "email": "user@example.com",
  "password": "Password123",
  "first_name": "Jean",
  "last_name": "Dupont",
  "role": "gestionnaire"
}

RÃ‰PONSE SUCCÃˆS :
{
  "success": true,
  "user": {
    "id": "uuid",
    "email": "user@example.com",
    "first_name": "Jean",
    "last_name": "Dupont",
    "role": "gestionnaire"
  }
}

RÃ‰PONSE ERREUR :
{
  "error": "Message d'erreur"
}

DÃ‰PENDANCES :
  â€¢ lib/supabase/admin.ts â†’ createAdminClient()
  â€¢ lib/actions/auth.ts â†’ getProfile()
  â€¢ Env var: SUPABASE_SERVICE_ROLE_KEY

APPELÃ‰ PAR :
  â€¢ lib/actions/users.ts â†’ createUser()

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“„ FICHIER 2 : app/api/admin/users/[id]/route.ts
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

RÃ”LE : Supprimer un utilisateur OU rÃ©initialiser son mot de passe

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

A) MÃ‰THODE DELETE - Supprimer un utilisateur
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

   ENDPOINT : DELETE /api/admin/users/[id]

   FONCTIONNALITÃ‰S :
     âœ… VÃ©rifie que l'utilisateur actuel est admin
     âœ… EmpÃªche l'auto-suppression (ne peut pas supprimer son propre compte)
     âœ… Utilise createAdminClient() avec service_role
     âœ… Supprime l'utilisateur de auth.users
     âœ… Le profil est supprimÃ© automatiquement (cascade)

   EXEMPLE :
     DELETE /api/admin/users/abc-123-def

   RÃ‰PONSE SUCCÃˆS :
     { "success": true }

   APPELÃ‰ PAR :
     â€¢ lib/actions/users.ts â†’ deleteUser()

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

B) MÃ‰THODE PATCH - RÃ©initialiser le mot de passe
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

   ENDPOINT : PATCH /api/admin/users/[id]

   FONCTIONNALITÃ‰S :
     âœ… VÃ©rifie que l'utilisateur actuel est admin
     âœ… Valide le mot de passe (min 6 caractÃ¨res)
     âœ… Utilise createAdminClient() avec service_role
     âœ… Met Ã  jour le mot de passe dans auth.users

   BODY EXEMPLE :
     {
       "action": "reset_password",
       "password": "NewPassword123"
     }

   EXEMPLE :
     PATCH /api/admin/users/abc-123-def
     Body: { "action": "reset_password", "password": "NewPass123" }

   RÃ‰PONSE SUCCÃˆS :
     { "success": true }

   APPELÃ‰ PAR :
     â€¢ lib/actions/users.ts â†’ resetUserPassword()

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ” SÃ‰CURITÃ‰
â•â•â•â•â•â•â•â•â•â•â•

TOUTES les routes dans app/api/admin/* :

1. VARIABLE D'ENVIRONNEMENT REQUISE :
   SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

2. CLIENT ADMIN SUPABASE :
   â€¢ Utilise createAdminClient() (lib/supabase/admin.ts)
   â€¢ AccÃ¨s complet avec service_role
   â€¢ Jamais exposÃ© au client

3. VÃ‰RIFICATION DES PERMISSIONS :
   â€¢ Chaque route vÃ©rifie : profile.role === 'admin'
   â€¢ Retourne 403 Forbidden si non admin

4. VALIDATIONS :
   â€¢ Email valide
   â€¢ Mot de passe min 6 caractÃ¨res
   â€¢ RÃ´le valide (admin/gestionnaire/lecture)
   â€¢ Pas d'auto-suppression

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ”„ FLUX COMPLET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CRÃ‰ATION D'UTILISATEUR :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  Browser Form
    â†“ submit
  lib/actions/users.ts â†’ createUser()
    â†“ fetch POST
  app/api/admin/users/route.ts
    â†“ vÃ©rifie admin
  lib/supabase/admin.ts â†’ createAdminClient()
    â†“ service_role
  Supabase Auth
    â†“ crÃ©e auth.users
  Supabase DB
    â†“ crÃ©e profiles
  Response
    âœ… success + user data

SUPPRESSION D'UTILISATEUR :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  Browser Button
    â†“ confirm + click
  lib/actions/users.ts â†’ deleteUser()
    â†“ fetch DELETE
  app/api/admin/users/[id]/route.ts
    â†“ vÃ©rifie admin + pas auto-delete
  lib/supabase/admin.ts â†’ createAdminClient()
    â†“ service_role
  Supabase Auth
    â†“ supprime auth.users
  Cascade Delete
    â†“ supprime profiles
  Response
    âœ… success

RÃ‰INITIALISATION MOT DE PASSE :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  Browser Form
    â†“ submit
  lib/actions/users.ts â†’ resetUserPassword()
    â†“ fetch PATCH
  app/api/admin/users/[id]/route.ts
    â†“ vÃ©rifie admin + valide password
  lib/supabase/admin.ts â†’ createAdminClient()
    â†“ service_role
  Supabase Auth
    â†“ update password
  Response
    âœ… success

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… CHECKLIST
â•â•â•â•â•â•â•â•â•â•â•â•

Fichiers requis dans app/api/admin :

  [ ] app/api/admin/users/route.ts
  [ ] app/api/admin/users/[id]/route.ts

Fichiers de support requis :

  [ ] lib/supabase/admin.ts
  [ ] lib/actions/auth.ts (avec getProfile)
  [ ] lib/actions/users.ts (avec createUser, deleteUser, resetUserPassword)

Variables d'environnement :

  [ ] NEXT_PUBLIC_SUPABASE_URL
  [ ] NEXT_PUBLIC_SUPABASE_ANON_KEY
  [ ] SUPABASE_SERVICE_ROLE_KEY âš ï¸ CRITIQUE

Tests Ã  effectuer :

  [ ] CrÃ©er un utilisateur depuis /admin/users/new
  [ ] Modifier le rÃ´le d'un utilisateur
  [ ] RÃ©initialiser le mot de passe d'un utilisateur
  [ ] Supprimer un utilisateur
  [ ] Essayer de se supprimer soi-mÃªme (devrait Ã©chouer)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âš ï¸ RAPPELS IMPORTANTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. N'ajoutez AUCUN autre fichier dans app/api/admin
   Ces 2 fichiers sont suffisants !

2. La clÃ© SUPABASE_SERVICE_ROLE_KEY doit Ãªtre :
   â€¢ StockÃ©e dans Vercel Environment Variables
   â€¢ JAMAIS committÃ©e dans Git
   â€¢ JAMAIS exposÃ©e au client

3. Toutes les autres opÃ©rations utilisent des Server Actions
   (pas d'API routes pour foyers, abonnÃ©s, saisons, activitÃ©s)

4. L'API PDF est dans app/api/registrations/pdf/route.ts
   (pas dans app/api/admin)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    RÃ‰SUMÃ‰ ULTRA-RAPIDE                           â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                  â•‘
â•‘  app/api/admin contient EXACTEMENT 2 fichiers :                 â•‘
â•‘                                                                  â•‘
â•‘  1. users/route.ts         â†’ POST (crÃ©er)                       â•‘
â•‘  2. users/[id]/route.ts    â†’ DELETE (supprimer)                 â•‘
â•‘                              PATCH (reset password)             â•‘
â•‘                                                                  â•‘
â•‘  Variable requise : SUPABASE_SERVICE_ROLE_KEY                   â•‘
â•‘                                                                  â•‘
â•‘  C'est tout ! Rien d'autre ! ğŸ‰                                 â•‘
â•‘                                                                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
